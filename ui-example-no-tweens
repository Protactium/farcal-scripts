-- this shit is only for use on Farcal
-- it's NOT to be used for an actual GUI, it's only an example

-- EXAMPLE:
--[[
local lib = luau.load(game:HttpGet("url"))
local panel = lib.Panel({
    Title = "Demo Menu",
    Position = { x = 60, y = 60 },
    Size = { x = 260, y = 180 },
    Hotkey = 0x48,
})

local btn = panel:Button({ Text = "Click Me" })
btn:OnClick(function()
    print("clicked")
end)

local t = panel:Toggle({ Text = "Enable Feature", Default = false })
t:OnChanged(function(v)
    print("toggle", v)
end)
]]

local rs = game:GetService("RunService")
local lib = { _panels = {}, _connected = false }

local function setVisible(draws, visible)
    for _, d in ipairs(draws) do
        d.Visible = visible
    end
end

function lib.Panel(opts)
    opts = opts or {}
    local panel = {
        x = (opts.Position and opts.Position.x) or 60,
        y = (opts.Position and opts.Position.y) or 60,
        w = (opts.Size and opts.Size.x) or 240,
        h = (opts.Size and opts.Size.y) or 160,
        title = opts.Title or "Panel",
        visible = opts.Visible ~= false,
        hotkey = opts.Hotkey, 
        headerHeight = opts.HeaderHeight or 24,
        padding = opts.Padding or 8,
        controls = {},
        _dragging = false,
        _dragOffset = { x = 0, y = 0 },
        _lastMouseDown = false,
        _lastHotkey = false,
    }

    panel.bg = Drawing.new("Square")
    panel.bg.Filled = true
    panel.bg.Color = { r = 0.1, g = 0.1, b = 0.1 }
    panel.bg.Transparency = 1
    panel.bg.ZIndex = 1

    panel.header = Drawing.new("Square")
    panel.header.Filled = true
    panel.header.Color = { r = 0.15, g = 0.15, b = 0.15 }
    panel.header.Transparency = 1
    panel.header.ZIndex = 2

    panel.titleText = Drawing.new("Text")
    panel.titleText.Text = panel.title
    panel.titleText.TextSize = 16
    panel.titleText.Color = { r = 1, g = 1, b = 1 }
    panel.titleText.ZIndex = 3

    function panel:ApplyVisible()
        local all = { self.bg, self.header, self.titleText }
        for _, c in ipairs(self.controls) do
            table.insert(all, c.bg)
            table.insert(all, c.label)
            if c.indicator then
                table.insert(all, c.indicator)
            end
        end
        setVisible(all, self.visible)
    end

    function panel:Layout()
        self.bg.Position = { x = self.x, y = self.y }
        self.bg.Size = { x = self.w, y = self.h }

        self.header.Position = { x = self.x, y = self.y }
        self.header.Size = { x = self.w, y = self.headerHeight }

        self.titleText.Position = { x = self.x + self.padding, y = self.y + 4 }

        local cy = self.y + self.headerHeight + self.padding
        for _, c in ipairs(self.controls) do
            c.bg.Position = { x = self.x + self.padding, y = cy }
            c.bg.Size = { x = self.w - self.padding * 2, y = c.height }
            c.label.Position = { x = self.x + self.padding + 6, y = cy + 4 }
            if c.indicator then
                c.indicator.Position = { x = self.x + self.padding + 6, y = cy + 4 }
                c.indicator.Size = { x = 14, y = 14 }
                c.label.Position = { x = self.x + self.padding + 26, y = cy + 4 }
            end
            cy = cy + c.height + self.padding
        end
    end

    function panel:Button(opts2)
        opts2 = opts2 or {}
        local btn = { height = opts2.Height or 24 }

        btn.bg = Drawing.new("Square")
        btn.bg.Filled = true
        btn.bg.Color = { r = 0.2, g = 0.2, b = 0.2 }
        btn.bg.Transparency = 1
        btn.bg.ZIndex = 2

        btn.label = Drawing.new("Text")
        btn.label.Text = opts2.Text or "Button"
        btn.label.TextSize = 16
        btn.label.Color = { r = 1, g = 1, b = 1 }
        btn.label.ZIndex = 3

        btn.onClick = opts2.Callback
        function btn:OnClick(fn) self.onClick = fn end

        table.insert(self.controls, btn)
        self:Layout()
        self:ApplyVisible()
        return btn
    end

    function panel:Toggle(opts2)
        opts2 = opts2 or {}
        local t = { height = opts2.Height or 24, value = opts2.Default == true, kind = "toggle" }

        t.bg = Drawing.new("Square")
        t.bg.Filled = true
        t.bg.Color = { r = 0.2, g = 0.2, b = 0.2 }
        t.bg.Transparency = 1
        t.bg.ZIndex = 2

        t.indicator = Drawing.new("Square")
        t.indicator.Filled = true
        t.indicator.Transparency = 1
        t.indicator.ZIndex = 3

        t.label = Drawing.new("Text")
        t.label.Text = opts2.Text or "Toggle"
        t.label.TextSize = 16
        t.label.Color = { r = 1, g = 1, b = 1 }
        t.label.ZIndex = 3

        t.onChanged = opts2.Callback
        function t:OnChanged(fn) self.onChanged = fn end
        function t:Set(value)
            self.value = value and true or false
        end

        table.insert(self.controls, t)
        self:Layout()
        self:ApplyVisible()
        return t
    end

    table.insert(lib._panels, panel)
    panel:Layout()
    panel:ApplyVisible()

    if not lib._connected then
        lib._connected = rs.RenderStepped:Connect(function()
            local mouse = input.getmouseposition()
            local down = mouse and input.keypressed(0x01)

            for _, p in ipairs(lib._panels) do
                if p.hotkey then
                    local hk = input.keypressed(p.hotkey)
                    if hk and not p._lastHotkey then
                        p.visible = not p.visible
                        p:ApplyVisible()
                    end
                    p._lastHotkey = hk
                end

                if not p.visible then
                    p._lastMouseDown = down or false
                else
                    if mouse then
                        local mx, my = mouse.x, mouse.y
                        local function inRect(r)
                            return mx >= r.x and mx <= r.x + r.w and my >= r.y and my <= r.y + r.h
                        end

                        local header = { x = p.x, y = p.y, w = p.w, h = p.headerHeight }

                        if down and not p._lastMouseDown then
                            if inRect(header) then
                                p._dragging = true
                                p._dragOffset.x = mx - p.x
                                p._dragOffset.y = my - p.y
                            else
                                for _, c in ipairs(p.controls) do
                                    local r = { x = c.bg.Position.x, y = c.bg.Position.y, w = c.bg.Size.x, h = c.bg.Size.y }
                                    if inRect(r) then
                                        if c.kind == "toggle" then
                                            c.value = not c.value
                                            if c.onChanged then c.onChanged(c.value) end
                                        elseif c.onClick then
                                            c.onClick()
                                        end
                                    end
                                end
                            end
                        end

                        if not down then
                            p._dragging = false
                        end

                        if p._dragging then
                            p.x = mx - p._dragOffset.x
                            p.y = my - p._dragOffset.y
                            p:Layout()
                        end
                    end
                    p._lastMouseDown = down or false
                end

                for _, c in ipairs(p.controls) do
                    if c.kind == "toggle" then
                        if c.value then
                            c.indicator.Color = { r = 0.2, g = 0.9, b = 0.4 }
                        else
                            c.indicator.Color = { r = 0.4, g = 0.4, b = 0.4 }
                        end
                    end
                end
            end
        end)
    end

    return panel
end

return lib
